# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ WhatsApp GPT Bot –¥–ª—è Python

- [Documentation in English](./README.md)

–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è WhatsApp-–±–æ—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π OpenAI GPT, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –Ω–∞ –±–∞–∑–µ
whatsapp-chatbot-python –∏ GREEN-API.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥–µ–ª—è–º–∏ OpenAI GPT –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π GPT (GPT-3.5, GPT-4, GPT-4o, o1)
- –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Whisper API
- –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WhatsApp
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û (middleware) –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—Ç–≤–µ—Ç–æ–≤
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
- –°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π, —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω–∞—è –æ—Ç –±–∞–∑–æ–≤–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Python type hints –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ docstrings

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
pip install whatsapp-chatgpt-python
```

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`openai`, `whatsapp-chatbot-python` –∏ `requests`) –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

–ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–æ—Ç–∞ –≤–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ [GREEN-API](https://green-api.com/)
2. ID —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∏ API-—Ç–æ–∫–µ–Ω –∏–∑ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ GREEN-API
3. API-–∫–ª—é—á OpenAI –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ GPT

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```python
from whatsapp_chatgpt_python import WhatsappGptBot

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = WhatsappGptBot(
    id_instance="–≤–∞—à-id-—ç–∫–∑–µ–º–ø–ª—è—Ä–∞",
    api_token_instance="–≤–∞—à-api-—Ç–æ–∫–µ–Ω",
    openai_api_key="–≤–∞—à-openai-api-–∫–ª—é—á",
    model="gpt-4o",
    system_message="–í—ã - –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç."
)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.run_forever()
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞

–ë–æ—Ç –Ω–∞—Å–ª–µ–¥—É–µ—Ç –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ `GreenAPIBot`, –≤–∫–ª—é—á–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
—ç–∫–∑–µ–º–ø–ª—è—Ä–∞ GREEN-API.

–ü–æ–ª–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è WhatsappGptBot:

```python
bot = WhatsappGptBot(
    # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    id_instance="–≤–∞—à-id-—ç–∫–∑–µ–º–ø–ª—è—Ä–∞",
    api_token_instance="–≤–∞—à-api-—Ç–æ–∫–µ–Ω",
    openai_api_key="–≤–∞—à-openai-api-–∫–ª—é—á",

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ GPT-—Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    model="gpt-4o",  # –ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    max_history_length=10,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    system_message="–í—ã - –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",  # –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è
    temperature=0.5,  # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
    error_message="–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
    session_timeout=1800,  # –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (30 –º–∏–Ω—É—Ç)

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –±–æ—Ç–∞
    bot_debug_mode=False,  # –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏
    debug_mode=False,  # –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ API
    raise_errors=True,  # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
    settings={  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ GREEN-API
        "webhookUrl": "",  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π URL –¥–ª—è –≤–µ–±—Ö—É–∫–∞
        "webhookUrlToken": "",  # –¢–æ–∫–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –≤–µ–±—Ö—É–∫–∞
        "delaySendMessagesMilliseconds": 500,  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        "markIncomingMessagesReaded": "yes",  # –û—Ç–º–µ—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        "incomingWebhook": "yes",  # –í–∫–ª—é—á–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –≤–µ–±—Ö—É–∫–∏
        "keepOnlineStatus": "yes",  # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω –≤ WhatsApp
        "pollMessageWebhook": "yes",  # –í–∫–ª—é—á–∏—Ç—å –≤–µ–±—Ö—É–∫–∏ –¥–ª—è –æ–ø—Ä–æ—Å–æ–≤
    }
)
```

### WhatsappGptBot

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º WhatsApp-–±–æ—Ç–æ–º –Ω–∞ –±–∞–∑–µ OpenAI:

```python
from whatsapp_chatgpt_python import WhatsappGptBot

bot = WhatsappGptBot(
    id_instance="–≤–∞—à-id-—ç–∫–∑–µ–º–ø–ª—è—Ä–∞",
    api_token_instance="–≤–∞—à-api-—Ç–æ–∫–µ–Ω",
    openai_api_key="–≤–∞—à-openai-api-–∫–ª—é—á",
    model="gpt-4o",
    system_message="–í—ã - –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤.",
    max_history_length=15,
    temperature=0.7,
    settings={
        "webhookUrl": "",
        "markIncomingMessagesReaded": "yes",
        "keepOnlineStatus": "yes",
        "delaySendMessagesMilliseconds": 500,
    }
)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.run_forever()
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π WhatsApp –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ —Ñ–æ—Ä–º–∞—Ç, –ø–æ–Ω—è—Ç–Ω—ã–π –º–æ–¥–µ–ª—è–º OpenAI.

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π

- **–¢–µ–∫—Å—Ç**: –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**: –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –º–æ–¥–µ–ª—è—Ö —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
- **–ê—É–¥–∏–æ**: –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–µ–π
- **–í–∏–¥–µ–æ**: –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥–ø–∏—Å—è–º–∏
- **–î–æ–∫—É–º–µ–Ω—Ç—ã**: –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- **–û–ø—Ä–æ—Å—ã**: –°–æ–æ–±—â–µ–Ω–∏—è —Å –æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –æ–ø—Ä–æ—Å–æ–≤
- **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –û–±—â–∏–π –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
- **–ö–æ–Ω—Ç–∞–∫—Ç—ã**: –û–±—â–∏–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º

### –†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–µ—Å—Ç—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π:

```python
# –î–æ—Å—Ç—É–ø –∫ —Ä–µ–µ—Å—Ç—Ä—É
registry = bot.message_handlers


# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
class CustomMessageHandler(MessageHandler):
    def can_handle(self, notification):
        return notification.get_message_type() == "custom-type"

    async def process_message(self, notification, openai_client=None, model=None):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        return "–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç"


# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
bot.register_message_handler(CustomMessageHandler())

# –ó–∞–º–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
bot.replace_handler(TextMessageHandler, CustomTextHandler())
```

## –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û (Middleware)

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ GPT –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–≤–µ—Ç–æ–≤ –ø–µ—Ä–µ–¥
–æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π

```python
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ GPT
def custom_message_middleware(notification, message_content, messages, session_data):
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä
    if notification.get_message_type() == "textMessage" and notification.chat.endswith("@c.us"):
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
        enhanced_content = f"[–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] {message_content}"

        return {
            "message_content": enhanced_content,
            "messages": messages
        }

    return {
        "message_content": message_content,
        "messages": messages
    }


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û
bot.add_message_middleware(custom_message_middleware)
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤

```python
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ GPT –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
def custom_response_middleware(response, messages, session_data):
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
    formatted_response = response.replace("GPT", "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç").strip()

    # –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∏—Å—Ç–æ—Ä–∏–∏
    return {
        "response": formatted_response,
        "messages": messages
    }


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û
bot.add_response_middleware(custom_response_middleware)
```

## –î–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏

GPT-–±–æ—Ç —Ä–∞—Å—à–∏—Ä—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:

```python
@dataclass
class GPTSessionData:
    """–î–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è GPT-—Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤"""
    messages: List[Dict[str, Any]] = field(default_factory=list)
    last_activity: int = field(default_factory=lambda: int(time.time()))
    user_data: Dict[str, Any] = field(default_factory=dict)
    context: Dict[str, Any] = field(default_factory=dict)
```

–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∏ –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ –≤–∞—à–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–º –ü–û:

```python
def message_middleware(notification, content, messages, session_data):
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if "variables" not in session_data.context:
        session_data.context["variables"] = {}

    session_data.context["variables"]["last_interaction"] = int(time.time())

    return {"message_content": content, "messages": messages}
```

## –£—Ç–∏–ª–∏—Ç—ã

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –æ–±—â–∏—Ö –∑–∞–¥–∞—á:

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤

```python
from whatsapp_chatgpt_python import Utils

# –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞ –∏–∑ URL
temp_file = await Utils.download_media("https://example.com/image.jpg")

# –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∞—É–¥–∏–æ
from openai import OpenAI

openai_client = OpenAI(api_key="–≤–∞—à-openai-api-–∫–ª—é—á")
transcript = await Utils.transcribe_audio("/path/to/audio.ogg", openai_client)

# –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
import os

os.unlink(temp_file)
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–º

```python
from whatsapp_chatgpt_python import Utils

# –û–±—Ä–µ–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
trimmed_messages = Utils.trim_conversation_history(
    messages,
    10,  # –º–∞–∫—Å. –∫–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
    True  # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
)

# –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
estimated_tokens = Utils.estimate_tokens(messages)
```

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏ OpenAI

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –º–æ–¥–µ–ª–∏ OpenAI:

### –ú–æ–¥–µ–ª–∏ GPT-4

- gpt-4
- gpt-4-turbo
- gpt-4-turbo-preview
- gpt-4-1106-preview
- gpt-4-0125-preview
- gpt-4-32k

### –ú–æ–¥–µ–ª–∏ GPT-4o

- gpt-4o (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- gpt-4o-mini
- gpt-4o-2024-05-13

### –ú–æ–¥–µ–ª–∏ GPT-3.5

- gpt-3.5-turbo
- gpt-3.5-turbo-16k
- gpt-3.5-turbo-1106
- gpt-3.5-turbo-0125

### –ú–æ–¥–µ–ª–∏ o1

- o1
- o1-mini
- o1-preview

### –ú–æ–¥–µ–ª–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–°–ª–µ–¥—É—é—â–∏–µ –º–æ–¥–µ–ª–∏ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:

- gpt-4o
- gpt-4o-mini
- gpt-4-vision-preview
- gpt-4-turbo
- gpt-4-turbo-preview

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥

–ü–æ—Å–∫–æ–ª—å–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ whatsapp-chatbot-python, –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–º–∞–Ω–¥/—Ñ–∏–ª—å—Ç—Ä–æ–≤ –±–∞–∑–æ–≤–æ–π
–±–∏–±–ª–∏–æ—Ç–µ–∫–∏:

```python
@bot.router.message(command="help")
def help_handler(notification):
    help_text = (
        "ü§ñ *WhatsApp GPT –ë–æ—Ç* ü§ñ\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "‚Ä¢ */help* - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏\n"
        "‚Ä¢ */clear* - –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞\n"
        "‚Ä¢ */info* - –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ"
    )
    notification.answer(help_text)


# –ö–æ–º–∞–Ω–¥–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
@bot.router.message(command="clear")
def clear_history_handler(notification):
    chat_id = notification.chat

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏
    session_data = bot.get_session_data(chat_id)

    # –ü–æ–∏—Å–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    system_message = None
    for msg in session_data.messages:
        if msg.get("role") == "system":
            system_message = msg
            break

    # –°–±—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    if system_message:
        session_data.messages = [system_message]
    else:
        session_data.messages = []

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    bot.update_session_data(chat_id, session_data)

    notification.answer("üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–µ–Ω–∞! –ù–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ.")
```

### –û–±—Ö–æ–¥ GPT –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É GPT:

```python
@bot.router.message(command="weather")
def weather_handler(notification):
    notification.answer(
        "üå§Ô∏è –≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ –ø–æ–≥–æ–¥–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞.\n\n"
        "–í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–¥–µ—Å—å –±—ã–ª–æ –±—ã –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ API –ø–æ–≥–æ–¥—ã.\n\n"
        "–≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ GPT."
    )
```

### –Ø–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ GPT

–í—ã –º–æ–∂–µ—Ç–µ —è–≤–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É GPT –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:

```python
@bot.router.message(text_message="recommend")
def recommend_handler(notification):
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    notification.answer("–Ø –¥–∞–º –≤–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é. –î–∞–π—Ç–µ –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å...")
    # –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ GPT
    notification.process_with_gpt()
```

–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –µ–≥–æ –≤ GPT, –∏—Å–ø–æ–ª—å–∑—É—è –ø–∞—Ä–∞–º–µ—Ç—Ä `custom_message`:

```python
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç—Ö–æ, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ GPT
@bot.router.message(command="echo")
def echo_handler(notification):
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    message_text = notification.message_text
    command_parts = message_text.split(maxsplit=1)

    if len(command_parts) > 1:
        echo_text = command_parts[1]
        notification.answer(f"–í—ã —Å–∫–∞–∑–∞–ª–∏: {echo_text}\n\n–Ø —Å–ø—Ä–æ—à—É GPT –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å GPT, –Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–µ–∑ –∫–æ–º–∞–Ω–¥—ã)
        notification.process_with_gpt(custom_message=echo_text)
    else:
        notification.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /echo.")
```

–≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ, –∫–æ–≥–¥–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ GPT, –Ω–∞–ø—Ä–∏–º–µ—Ä, —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã
–∫–æ–º–∞–Ω–¥, –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
if bot.supports_images():
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    pass
```

## –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –±–æ—Ç–∞

–í–æ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä WhatsApp GPT –±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º –ü–û:

```python
import os
import time
import logging
from whatsapp_chatgpt_python import (
    WhatsappGptBot,
    ImageMessageHandler,
    TextMessageHandler
)
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
load_dotenv()
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger('whatsapp_chatgpt_python')

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
ID_INSTANCE = os.environ.get("INSTANCE_ID")
API_TOKEN = os.environ.get("INSTANCE_TOKEN")
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = WhatsappGptBot(
    id_instance=ID_INSTANCE,
    api_token_instance=API_TOKEN,
    openai_api_key=OPENAI_API_KEY,
    model="gpt-4o",  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª—å GPT-4o (–∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    system_message="–í—ã - –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ë—É–¥—å—Ç–µ –∫—Ä–∞—Ç–∫–∏–º–∏ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º–∏ –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö.",
    max_history_length=15,  # –•—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    temperature=0.7,  # –ù–µ–º–Ω–æ–≥–æ –±–æ–ª–µ–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
    session_timeout=1800,  # –°–µ—Å—Å–∏–∏ –∏—Å—Ç–µ–∫–∞—é—Ç –ø–æ—Å–ª–µ 30 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    error_message="–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å.",  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
)


# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
class EnhancedImageHandler(ImageMessageHandler):
    async def process_message(self, notification, openai_client=None, model=None):
        # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        result = await super().process_message(notification, openai_client, model)

        # –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–Ω–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏)
        if isinstance(result, str):
            return result.replace(
                "[The user sent an image",
                "[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ –Ω–µ–º, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø–æ–¥–ø–∏—Å–∏"
            )

        # –î–ª—è –º–æ–¥–µ–ª–µ–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —É–ª—É—á—à–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        if isinstance(result, list) and len(result) > 0 and isinstance(result[0], dict):
            if result[0].get('type') == 'text':
                text = result[0].get('text', '')
                if text == "Analyzing this image":
                    result[0]['text'] = "–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ç–æ, —á—Ç–æ –≤—ã –Ω–∞ –Ω–µ–º –≤–∏–¥–∏—Ç–µ."

        return result


# –ü—Ä–∏–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
class EnhancedTextHandler(TextMessageHandler):
    async def process_message(self, notification, *args, **kwargs):
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞
        text = await super().process_message(notification, *args, **kwargs)

        if not text:
            return text

        lower_text = text.lower()

        if any(term in lower_text for term in ['–∫–æ–¥', '—Ñ—É–Ω–∫—Ü–∏—è', '—Å–∫—Ä–∏–ø—Ç', '–ø—Ä–æ–≥—Ä–∞–º–º–∞']):
            return f"üßë‚Äçüíª –ó–ê–ü–†–û–° –ù–ê –ö–û–î: {text}\n\n[–Ø –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é –º–æ–π –æ—Ç–≤–µ—Ç —Å –∫–æ–¥–æ–º —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞]"

        elif text.endswith('?') or text.lower().startswith(
                ('—á—Ç–æ', '–ø–æ—á–µ–º—É', '–∫–∞–∫', '–∫–æ–≥–¥–∞', '–≥–¥–µ', '–∫—Ç–æ', '–º–æ–∂–Ω–æ', '–º–æ–≥')):
            return f"‚ùì –í–û–ü–†–û–°: {text}\n\n[–Ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é —á–µ—Ç–∫–∏–π –∏ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç]"

        return text


# –ó–∞–º–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –Ω–∞—à–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
bot.replace_handler(ImageMessageHandler, EnhancedImageHandler())
bot.replace_handler(TextMessageHandler, EnhancedTextHandler())


# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—Ä–µ–∫–∏–Ω–≥–µ
def logging_middleware(notification, message_content, messages, session_data):
    user_id = notification.sender
    if isinstance(message_content, str):
        content_display = message_content[:100] + "..." if len(message_content) > 100 else message_content
    else:
        content_display = "—Å–ª–æ–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–≤–µ—Ä–æ—è—Ç–Ω–æ, —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ–¥–∏–∞)"

    logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: {content_display}")

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—Ä–µ–∫–∏–Ω–≥–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏
    if not session_data.context.get("variables"):
        session_data.context["variables"] = {}

    session_data.context["variables"].update({
        "last_interaction": int(time.time()),
        "message_count": session_data.context.get("variables", {}).get("message_count", 0) + 1
    })

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    return {"message_content": message_content, "messages": messages}


# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
def formatting_middleware(response, messages, session_data):
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç, –¥–æ–±–∞–≤–ª—è—è –ø–æ–¥–ø–∏—Å—å –≤ –∫–æ–Ω—Ü–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    formatted_response = response.strip()

    # –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –∫ –∫–æ—Ä–æ—Ç–∫–∏–º –æ—Ç–≤–µ—Ç–∞–º
    if len(formatted_response) > 100 and not formatted_response.endswith("_"):
        message_count = session_data.context.get("variables", {}).get("message_count", 0)
        formatted_response += f"\n\n_–°–æ–æ–±—â–µ–Ω–∏–µ #{message_count} ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ GPT_"

    return {"response": formatted_response, "messages": messages}


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û
bot.add_message_middleware(logging_middleware)
bot.add_response_middleware(formatting_middleware)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /clear –¥–ª—è —Å–±—Ä–æ—Å–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
@bot.router.message(command="clear")
def clear_history_handler(notification):
    chat_id = notification.chat

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏
    session_data = bot.get_session_data(chat_id)

    # –ü–æ–∏—Å–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    system_message = None
    for msg in session_data.messages:
        if msg.get("role") == "system":
            system_message = msg
            break

    # –°–±—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    if system_message:
        session_data.messages = [system_message]
    else:
        session_data.messages = []

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    bot.update_session_data(chat_id, session_data)

    notification.answer("üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–µ–Ω–∞! –ù–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ.")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
@bot.router.message(command="help")
def help_handler(notification):
    help_text = (
        "ü§ñ *WhatsApp GPT –ë–æ—Ç* ü§ñ\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "‚Ä¢ */help* - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏\n"
        "‚Ä¢ */clear* - –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞\n"
        "‚Ä¢ */info* - –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ\n"
        "‚Ä¢ */weather* - –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞, –ø—Ä–æ–ø—É—Å–∫–∞—é—â–µ–≥–æ GPT\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∞—É–¥–∏–æ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ. –Ø –±—É–¥—É –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è."
    )
    notification.answer(help_text)


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã info
@bot.router.message(command="info")
def info_handler(notification):
    chat_id = notification.chat
    session_data = bot.get_session_data(chat_id)

    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Å—Å–∏–∏
    message_count = len(session_data.messages) - 1  # –í—ã—á–∏—Ç–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if message_count < 0:
        message_count = 0

    vision_capable = "–î–∞" if bot.supports_images() else "–ù–µ—Ç"

    info_text = (
        "üìä *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ* üìä\n\n"
        f"–ú–æ–¥–µ–ª—å: {bot.get_model()}\n"
        f"–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {vision_capable}\n"
        f"–°–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏: {message_count}\n"
        f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏: {bot.max_history_length}\n"
        f"–¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏: {bot.session_timeout} —Å–µ–∫—É–Ω–¥\n\n"
        "–ß—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ */clear*"
    )
    notification.answer(info_text)


# –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø–æ–≥–æ–¥—ã, –ø—Ä–æ–ø—É—Å–∫–∞—é—â–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∫—É GPT
@bot.router.message(command="weather")
def weather_handler(notification):
    notification.answer(
        "üå§Ô∏è –≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ –ø–æ–≥–æ–¥–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞.\n\n"
        "–í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–¥–µ—Å—å –±—ã–ª–æ –±—ã –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ API –ø–æ–≥–æ–¥—ã.\n\n"
        "–≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ GPT."
    )


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    logger.info("–ó–∞–ø—É—Å–∫ WhatsApp GPT –ë–æ—Ç–∞...")
    logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å: {bot.get_model()}")
    bot.run_forever()
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

–≠—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ:

- [whatsapp-chatbot-python](https://github.com/green-api/whatsapp-chatbot-python) - –ë–∞–∑–æ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ WhatsApp-–±–æ—Ç–∞
- [GREEN-API](https://green-api.com/) - –°–µ—Ä–≤–∏—Å API WhatsApp –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–æ—Ç–æ–≤
- [OpenAI API](https://openai.com/) - –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π GPT
